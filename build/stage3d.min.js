var stageJS;!function(a){var b=function(){function a(a,b,c,d){"undefined"==typeof c&&(c=!0),"undefined"==typeof d&&(d=4294967295),this._transparent=c,this._canvas=document.createElement("canvas"),this._canvas.width=a,this._canvas.height=b,this._context=this._canvas.getContext("2d"),this._rect={x:0,y:0,width:a,height:b},this.fillRect(this._rect,d)}return Object.defineProperty(a.prototype,"width",{get:function(){return this._canvas.width},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"height",{get:function(){return this._canvas.height},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"canvas",{get:function(){return this._canvas},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"imageData",{get:function(){return this._context.getImageData(0,0,this._canvas.width,this._canvas.height)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rect",{get:function(){return this._rect},enumerable:!0,configurable:!0}),a.prototype.copyPixels=function(b,c,d){b instanceof a?this._context.drawImage(b.canvas,c.x,c.y,c.width,c.height,d.x,d.y,c.width,c.height):this._context.drawImage(b,c.x,c.y,c.width,c.height,d.x,d.y,c.width,c.height)},a.prototype.draw=function(b){b instanceof a?this._context.drawImage(b.canvas,0,0):this._context.drawImage(b,0,0)},a.prototype.fillRect=function(a,b){this._context.fillStyle=this.hexToRGBACSS(b),this._context.fillRect(a.x,a.y,a.width,a.height)},a.prototype.hexToRGBACSS=function(a){var b=(16711680&a)>>>16,c=(65280&a)>>>8,d=255&a;if(this._transparent)var e=((4278190080&a)>>>24)/255;else var e=1;return"rgba("+b+","+c+","+d+","+e+")"},a}();a.BitmapData=b}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function a(a){this.type=void 0,this.target=void 0,this.type=a}return a.prototype.clone=function(){return new a(this.type)},a.CONTEXT3D_CREATE="CONTEXT3D_CREATE",a}();a.Event=b}(a.events||(a.events={}));a.events}(stageJS||(stageJS={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},stageJS;!function(a){!function(b){var c=function(a){function b(){a.call(this,b.ERROR)}return __extends(b,a),b.ERROR="error",b}(a.events.Event);b.ErrorEvent=c}(a.events||(a.events={}));a.events}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function a(a){"undefined"==typeof a&&(a=null),this.listeners=new Array,this.target=a||this}return a.prototype.addEventListener=function(a,b){void 0===this.listeners[a]&&(this.listeners[a]=new Array),-1===this.getEventListenerIndex(a,b)&&this.listeners[a].push(b)},a.prototype.removeEventListener=function(a,b){var c=this.getEventListenerIndex(a,b);-1!==c&&this.listeners[a].splice(c,1)},a.prototype.dispatchEvent=function(a){var b=this.listeners[a.type];if(void 0!==b){var c=b.length;a.target=this.target;for(var d=0;c>d;d++)b[d](a)}},a.prototype.getEventListenerIndex=function(a,b){if(void 0!==this.listeners[a])for(var c=this.listeners[a],d=c.length,e=0;d>e;e++)if(b==c[e])return e;return-1},a.prototype.hasEventListener=function(a,b){return null!=b?-1!==this.getEventListenerIndex(a,b):void 0!==this.listeners[a]?this.listeners[a].length>0:!1},a}();a.EventDispatcher=b}(a.events||(a.events={}));a.events}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function a(){}return a.AXIS_ANGLE="axisAngle",a.EULER_ANGLES="eulerAngles",a.QUATERNION="quaternion",a}();a.Orientation3D=b}(a.geom||(a.geom={}));a.geom}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function a(a,b,c,d){"undefined"==typeof a&&(a=0),"undefined"==typeof b&&(b=0),"undefined"==typeof c&&(c=0),"undefined"==typeof d&&(d=0),this.x=a,this.y=b,this.z=c,this.w=d}return Object.defineProperty(a.prototype,"length",{get:function(){return Math.sqrt(this.lengthSquared)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"lengthSquared",{get:function(){return this.x*this.x+this.y*this.y+this.z*this.z},enumerable:!0,configurable:!0}),a.angleBetween=function(a,b){return Math.acos(a.dotProduct(b)/(a.length*b.length))},a.distance=function(a,b){var c=a.x-b.x,d=a.y-b.y,e=a.z-b.z;return Math.sqrt(c*c+d*d+e*e)},a.prototype.add=function(b){return new a(this.x+b.x,this.y+b.y,this.z+b.z)},a.prototype.subtract=function(b){return new a(this.x-b.x,this.y-b.y,this.z-b.z)},a.prototype.incrementBy=function(a){this.x+=a.x,this.y+=a.y,this.z+=a.z},a.prototype.decrementBy=function(a){this.x-=a.x,this.y-=a.y,this.z-=a.z},a.prototype.equals=function(a,b){return"undefined"==typeof b&&(b=!1),this.x==a.x&&this.y==a.y&&this.z==a.z&&(b?this.w==a.w:!0)},a.prototype.nearEquals=function(a,b,c){"undefined"==typeof c&&(c=!1);var d=Math.abs;return d(this.x-a.x)<b&&d(this.y-a.y)<b&&d(this.z-a.z)<b&&(c?d(this.w-a.w)<b:!0)},a.prototype.clone=function(){return new a(this.x,this.y,this.z,this.w)},a.prototype.copyFrom=function(a){this.x=a.x,this.y=a.y,this.z=a.z,this.w=a.w},a.prototype.negate=function(){this.x=-this.x,this.y=-this.y,this.z=-this.z},a.prototype.scaleBy=function(a){this.x*=a,this.y*=a,this.z*=a},a.prototype.setTo=function(a,b,c){this.x=a,this.y=b,this.z=c},a.prototype.normalize=function(){var a=this.length;return 0!=a&&this.scaleBy(1/a),a},a.prototype.crossProduct=function(b){return new a(this.y*b.z-this.z*b.y,this.z*b.x-this.x*b.z,this.x*b.y-this.y*b.x)},a.prototype.dotProduct=function(a){return this.x*a.x+this.y*a.y+this.z*a.z},a.prototype.project=function(){0!=this.w&&(this.x/=this.w,this.y/=this.w,this.z/=this.w)},a.prototype.toString=function(){return"[Vector3D] (x:"+this.x+" ,y:"+this.y+", z:"+this.z+", w:"+this.w+")"},a.X_AXIS=new a(1,0,0),a.Y_AXIS=new a(0,1,0),a.Z_AXIS=new a(0,0,1),a}();a.Vector3D=b}(a.geom||(a.geom={}));a.geom}(stageJS||(stageJS={}));var stageJS;!function(a){!function(b){var c=function(){function c(a){"undefined"==typeof a&&(a=null),this.rawData=new Float32Array(null!=a&&16==a.length?a.slice(0):[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return Object.defineProperty(c.prototype,"determinant",{get:function(){return(this.rawData[0]*this.rawData[5]-this.rawData[4]*this.rawData[1])*(this.rawData[10]*this.rawData[15]-this.rawData[14]*this.rawData[11])-(this.rawData[0]*this.rawData[9]-this.rawData[8]*this.rawData[1])*(this.rawData[6]*this.rawData[15]-this.rawData[14]*this.rawData[7])+(this.rawData[0]*this.rawData[13]-this.rawData[12]*this.rawData[1])*(this.rawData[6]*this.rawData[11]-this.rawData[10]*this.rawData[7])+(this.rawData[4]*this.rawData[9]-this.rawData[8]*this.rawData[5])*(this.rawData[2]*this.rawData[15]-this.rawData[14]*this.rawData[3])-(this.rawData[4]*this.rawData[13]-this.rawData[12]*this.rawData[5])*(this.rawData[2]*this.rawData[11]-this.rawData[10]*this.rawData[3])+(this.rawData[8]*this.rawData[13]-this.rawData[12]*this.rawData[9])*(this.rawData[2]*this.rawData[7]-this.rawData[6]*this.rawData[3])},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"position",{get:function(){return new b.Vector3D(this.rawData[12],this.rawData[13],this.rawData[14])},enumerable:!0,configurable:!0}),c.prototype.append=function(a){var b=this.rawData[0],c=this.rawData[1],d=this.rawData[2],e=this.rawData[3],f=this.rawData[4],g=this.rawData[5],h=this.rawData[6],i=this.rawData[7],j=this.rawData[8],k=this.rawData[9],l=this.rawData[10],m=this.rawData[11],n=this.rawData[12],o=this.rawData[13],p=this.rawData[14],q=this.rawData[15],r=a.rawData[0],s=a.rawData[1],t=a.rawData[2],u=a.rawData[3],v=a.rawData[4],w=a.rawData[5],x=a.rawData[6],y=a.rawData[7],z=a.rawData[8],A=a.rawData[9],B=a.rawData[10],C=a.rawData[11],D=a.rawData[12],E=a.rawData[13],F=a.rawData[14],G=a.rawData[15];this.rawData[0]=b*r+c*v+d*z+e*D,this.rawData[1]=b*s+c*w+d*A+e*E,this.rawData[2]=b*t+c*x+d*B+e*F,this.rawData[3]=b*u+c*y+d*C+e*G,this.rawData[4]=f*r+g*v+h*z+i*D,this.rawData[5]=f*s+g*w+h*A+i*E,this.rawData[6]=f*t+g*x+h*B+i*F,this.rawData[7]=f*u+g*y+h*C+i*G,this.rawData[8]=j*r+k*v+l*z+m*D,this.rawData[9]=j*s+k*w+l*A+m*E,this.rawData[10]=j*t+k*x+l*B+m*F,this.rawData[11]=j*u+k*y+l*C+m*G,this.rawData[12]=n*r+o*v+p*z+q*D,this.rawData[13]=n*s+o*w+p*A+q*E,this.rawData[14]=n*t+o*x+p*B+q*F,this.rawData[15]=n*u+o*y+p*C+q*G},c.prototype.prepend=function(a){var b=this.rawData[0],c=this.rawData[1],d=this.rawData[2],e=this.rawData[3],f=this.rawData[4],g=this.rawData[5],h=this.rawData[6],i=this.rawData[7],j=this.rawData[8],k=this.rawData[9],l=this.rawData[10],m=this.rawData[11],n=this.rawData[12],o=this.rawData[13],p=this.rawData[14],q=this.rawData[15],r=a.rawData[0],s=a.rawData[1],t=a.rawData[2],u=a.rawData[3],v=a.rawData[4],w=a.rawData[5],x=a.rawData[6],y=a.rawData[7],z=a.rawData[8],A=a.rawData[9],B=a.rawData[10],C=a.rawData[11],D=a.rawData[12],E=a.rawData[13],F=a.rawData[14],G=a.rawData[15];this.rawData[0]=r*b+s*f+t*j+u*n,this.rawData[1]=r*c+s*g+t*k+u*o,this.rawData[2]=r*d+s*h+t*l+u*p,this.rawData[3]=r*e+s*i+t*m+u*q,this.rawData[4]=v*b+w*f+x*j+y*n,this.rawData[5]=v*c+w*g+x*k+y*o,this.rawData[6]=v*d+w*h+x*l+y*p,this.rawData[7]=v*e+w*i+x*m+y*q,this.rawData[8]=z*b+A*f+B*j+C*n,this.rawData[9]=z*c+A*g+B*k+C*o,this.rawData[10]=z*d+A*h+B*l+C*p,this.rawData[11]=z*e+A*i+B*m+C*q,this.rawData[12]=D*b+E*f+F*j+G*n,this.rawData[13]=D*c+E*g+F*k+G*o,this.rawData[14]=D*d+E*h+F*l+G*p,this.rawData[15]=D*e+E*i+F*m+G*q},c.prototype.appendRotation=function(a,b,d){"undefined"==typeof d&&(d=null);var e=this.getRotateMatrix(b,a*c.DEG_2_RAD);d?(this.appendTranslation(-d.x,-d.y,-d.z),this.append(e),this.appendTranslation(d.x,d.y,d.z)):this.append(e)},c.prototype.appendScale=function(a,b,c){this.rawData[0]*=a,this.rawData[1]*=b,this.rawData[2]*=c,this.rawData[4]*=a,this.rawData[5]*=b,this.rawData[6]*=c,this.rawData[8]*=a,this.rawData[9]*=b,this.rawData[10]*=c,this.rawData[12]*=a,this.rawData[13]*=b,this.rawData[14]*=c},c.prototype.appendTranslation=function(a,b,c){this.rawData[12]+=a,this.rawData[13]+=b,this.rawData[14]+=c},c.prototype.prependRotation=function(a,b,d){"undefined"==typeof d&&(d=null);var e=this.getRotateMatrix(b,a*c.DEG_2_RAD);d?(this.prependTranslation(d.x,d.y,d.z),this.prepend(e),this.prependTranslation(-d.x,-d.y,-d.z)):this.prepend(e)},c.prototype.prependScale=function(a,b,c){this.rawData[0]*=a,this.rawData[1]*=a,this.rawData[2]*=a,this.rawData[3]*=a,this.rawData[4]*=b,this.rawData[5]*=b,this.rawData[6]*=b,this.rawData[7]*=b,this.rawData[8]*=c,this.rawData[9]*=c,this.rawData[10]*=c,this.rawData[11]*=c},c.prototype.prependTranslation=function(a,b,c){this.rawData[12]+=this.rawData[0]*a+this.rawData[4]*b+this.rawData[8]*c,this.rawData[13]+=this.rawData[1]*a+this.rawData[5]*b+this.rawData[9]*c,this.rawData[14]+=this.rawData[2]*a+this.rawData[6]*b+this.rawData[10]*c,this.rawData[15]+=this.rawData[3]*a+this.rawData[7]*b+this.rawData[11]*c},c.prototype.clone=function(){return new c(Array.prototype.slice.call(this.rawData))},c.prototype.copyColumnFrom=function(a,b){if(0>a||a>3)throw new Error("column error");this.rawData[4*a+0]=b.x,this.rawData[4*a+1]=b.y,this.rawData[4*a+2]=b.z,this.rawData[4*a+3]=b.w},c.prototype.copyColumnTo=function(a,b){if(0>a||a>3)throw new Error("column error");b.x=this.rawData[4*a],b.y=this.rawData[4*a+1],b.z=this.rawData[4*a+2],b.w=this.rawData[4*a+3]},c.prototype.copyFrom=function(a){for(var b=a.rawData.length,c=0;b>c;c++)this.rawData[c]=a.rawData[c]},c.prototype.copyRawDataFrom=function(a,b,c){"undefined"==typeof b&&(b=0),"undefined"==typeof c&&(c=!1),c&&this.transpose();for(var d=a.length-b,e=0;d>e;e++)this.rawData[e]=a[e+b];c&&this.transpose()},c.prototype.copyRawDataTo=function(a,b,c){"undefined"==typeof b&&(b=0),"undefined"==typeof c&&(c=!1),c&&this.transpose();for(var d=this.rawData.length,e=0;d>e;e++)a[e+b]=this.rawData[e];if(b>=0){for(var f=0;b>f;f++)a[f]=0;a.length=b+d}c&&this.transpose()},c.prototype.copyRowFrom=function(a,b){if(0>a||a>3)throw new Error("row error");this.rawData[a]=b.x,this.rawData[a+4]=b.y,this.rawData[a+8]=b.z,this.rawData[a+12]=b.w},c.prototype.copyRowTo=function(a,b){if(0>a||a>3)throw new Error("row error");b.x=this.rawData[a],b.y=this.rawData[a+4],b.z=this.rawData[a+8],b.w=this.rawData[a+12]},c.prototype.copyToMatrix3D=function(a){a.rawData.set(this.rawData)},c.prototype.decompose=function(c){"undefined"==typeof c&&(c="eulerAngles");var d=[],e=this.clone(),f=e.rawData,g=new b.Vector3D(f[12],f[13],f[14]);f[12]=0,f[13]=0,f[14]=0;var h=new b.Vector3D;h.x=Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2]),h.y=Math.sqrt(f[4]*f[4]+f[5]*f[5]+f[6]*f[6]),h.z=Math.sqrt(f[8]*f[8]+f[9]*f[9]+f[10]*f[10]),f[0]*(f[5]*f[10]-f[6]*f[9])-f[1]*(f[4]*f[10]-f[6]*f[8])+f[2]*(f[4]*f[9]-f[5]*f[8])<0&&(h.z=-h.z),f[0]/=h.x,f[1]/=h.x,f[2]/=h.x,f[4]/=h.y,f[5]/=h.y,f[6]/=h.y,f[8]/=h.z,f[9]/=h.z,f[10]/=h.z;var i=new b.Vector3D;switch(c){case a.geom.Orientation3D.AXIS_ANGLE:i.w=Math.acos((f[0]+f[5]+f[10]-1)/2);var j=Math.sqrt((f[6]-f[9])*(f[6]-f[9])+(f[8]-f[2])*(f[8]-f[2])+(f[1]-f[4])*(f[1]-f[4]));i.x=(f[6]-f[9])/j,i.y=(f[8]-f[2])/j,i.z=(f[1]-f[4])/j;break;case a.geom.Orientation3D.QUATERNION:var k=f[0]+f[5]+f[10];k>0?(i.w=Math.sqrt(1+k)/2,i.x=(f[6]-f[9])/(4*i.w),i.y=(f[8]-f[2])/(4*i.w),i.z=(f[1]-f[4])/(4*i.w)):f[0]>f[5]&&f[0]>f[10]?(i.x=Math.sqrt(1+f[0]-f[5]-f[10])/2,i.w=(f[6]-f[9])/(4*i.x),i.y=(f[1]+f[4])/(4*i.x),i.z=(f[8]+f[2])/(4*i.x)):f[5]>f[10]?(i.y=Math.sqrt(1+f[5]-f[0]-f[10])/2,i.x=(f[1]+f[4])/(4*i.y),i.w=(f[8]-f[2])/(4*i.y),i.z=(f[6]+f[9])/(4*i.y)):(i.z=Math.sqrt(1+f[10]-f[0]-f[5])/2,i.x=(f[8]+f[2])/(4*i.z),i.y=(f[6]+f[9])/(4*i.z),i.w=(f[1]-f[4])/(4*i.z));break;case a.geom.Orientation3D.EULER_ANGLES:i.y=Math.asin(-f[2]),1!=f[2]&&-1!=f[2]?(i.x=Math.atan2(f[6],f[10]),i.z=Math.atan2(f[1],f[0])):(i.z=0,i.x=Math.atan2(f[4],f[5]))}return d.push(g),d.push(i),d.push(h),d},c.prototype.identity=function(){this.rawData=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},c.interpolate=function(a,c,d){var e=(new b.Quaternion).fromMatrix3D(a),f=(new b.Quaternion).fromMatrix3D(c);return b.Quaternion.lerp(e,f,d).toMatrix3D()},c.prototype.interpolateTo=function(a,b){this.rawData.set(c.interpolate(this,a,b).rawData)},c.prototype.invert=function(){var a=this.determinant,b=Math.abs(a)>1e-11;if(b){a=1/a;var c=this.rawData[0],d=this.rawData[4],e=this.rawData[8],f=this.rawData[12],g=this.rawData[1],h=this.rawData[5],i=this.rawData[9],j=this.rawData[13],k=this.rawData[2],l=this.rawData[6],m=this.rawData[10],n=this.rawData[14],o=this.rawData[3],p=this.rawData[7],q=this.rawData[11],r=this.rawData[15];this.rawData[0]=a*(h*(m*r-n*q)-i*(l*r-n*p)+j*(l*q-m*p)),this.rawData[1]=-a*(g*(m*r-n*q)-i*(k*r-n*o)+j*(k*q-m*o)),this.rawData[2]=a*(g*(l*r-n*p)-h*(k*r-n*o)+j*(k*p-l*o)),this.rawData[3]=-a*(g*(l*q-m*p)-h*(k*q-m*o)+i*(k*p-l*o)),this.rawData[4]=-a*(d*(m*r-n*q)-e*(l*r-n*p)+f*(l*q-m*p)),this.rawData[5]=a*(c*(m*r-n*q)-e*(k*r-n*o)+f*(k*q-m*o)),this.rawData[6]=-a*(c*(l*r-n*p)-d*(k*r-n*o)+f*(k*p-l*o)),this.rawData[7]=a*(c*(l*q-m*p)-d*(k*q-m*o)+e*(k*p-l*o)),this.rawData[8]=a*(d*(i*r-j*q)-e*(h*r-j*p)+f*(h*q-i*p)),this.rawData[9]=-a*(c*(i*r-j*q)-e*(g*r-j*o)+f*(g*q-i*o)),this.rawData[10]=a*(c*(h*r-j*p)-d*(g*r-j*o)+f*(g*p-h*o)),this.rawData[11]=-a*(c*(h*q-i*p)-d*(g*q-i*o)+e*(g*p-h*o)),this.rawData[12]=-a*(d*(i*n-j*m)-e*(h*n-j*l)+f*(h*m-i*l)),this.rawData[13]=a*(c*(i*n-j*m)-e*(g*n-j*k)+f*(g*m-i*k)),this.rawData[14]=-a*(c*(h*n-j*l)-d*(g*n-j*k)+f*(g*l-h*k)),this.rawData[15]=a*(c*(h*m-i*l)-d*(g*m-i*k)+e*(g*l-h*k))}return b},c.prototype.pointAt=function(a,b,c){"undefined"==typeof b&&(b=null),"undefined"==typeof c&&(c=null),console.log("pointAt not impletement")},c.prototype.recompose=function(b,c){if("undefined"==typeof c&&(c="eulerAngles"),b.length<3)return!1;var d=b[2],e=b[0],f=b[1];return this.identity(),this.appendScale(d.x,d.y,d.z),this.append(this.getRotateMatrix(a.geom.Vector3D.X_AXIS,f.x)),this.append(this.getRotateMatrix(a.geom.Vector3D.Y_AXIS,f.y)),this.append(this.getRotateMatrix(a.geom.Vector3D.Z_AXIS,f.z)),this.rawData[12]=e.x,this.rawData[13]=e.y,this.rawData[14]=e.z,this.rawData[15]=1,!0},c.prototype.transformVector=function(a){return new b.Vector3D(a.x*this.rawData[0]+a.y*this.rawData[4]+a.z*this.rawData[8]+this.rawData[12],a.x*this.rawData[1]+a.y*this.rawData[5]+a.z*this.rawData[9]+this.rawData[13],a.x*this.rawData[2]+a.y*this.rawData[6]+a.z*this.rawData[10]+this.rawData[14],a.x*this.rawData[3]+a.y*this.rawData[7]+a.z*this.rawData[11]+this.rawData[15])},c.prototype.deltaTransformVector=function(a){return new b.Vector3D(a.x*this.rawData[0]+a.y*this.rawData[4]+a.z*this.rawData[8],a.x*this.rawData[1]+a.y*this.rawData[5]+a.z*this.rawData[9],a.x*this.rawData[2]+a.y*this.rawData[6]+a.z*this.rawData[10],a.x*this.rawData[3]+a.y*this.rawData[7]+a.z*this.rawData[11])},c.prototype.transformVectors=function(a,b){for(var c=0,d=0,e=0,f=0;c+3<=a.length;)d=a[c],e=a[c+1],f=a[c+2],b[c]=d*this.rawData[0]+e*this.rawData[4]+f*this.rawData[8]+this.rawData[12],b[c+1]=d*this.rawData[1]+e*this.rawData[5]+f*this.rawData[9]+this.rawData[13],b[c+2]=d*this.rawData[2]+e*this.rawData[6]+f*this.rawData[10]+this.rawData[14],c+=3},c.prototype.transpose=function(){var a=this.rawData[1],b=this.rawData[2],c=this.rawData[3],d=this.rawData[4],e=this.rawData[6],f=this.rawData[7],g=this.rawData[8],h=this.rawData[9],i=this.rawData[11],j=this.rawData[12],k=this.rawData[13],l=this.rawData[14];this.rawData[1]=d,this.rawData[2]=g,this.rawData[3]=j,this.rawData[4]=a,this.rawData[6]=h,this.rawData[7]=k,this.rawData[8]=b,this.rawData[9]=e,this.rawData[11]=l,this.rawData[12]=c,this.rawData[13]=f,this.rawData[14]=i},c.prototype.toString=function(){for(var a="[Matrix3D]\n",b=0;b<this.rawData.length;b++)a+=this.rawData[b]+"  , ",(b+1)%4==0&&(a+="\n");return a},c.prototype.getRotateMatrix=function(a,b){var d,e=a.x,f=a.y,g=a.z,h=Math.cos(b),i=Math.sin(b);if(0!=e&&0==f&&0==g)d=new c([1,0,0,0,0,h,i,0,0,-i,h,0,0,0,0,1]);else if(0!=f&&0==e&&0==g)d=new c([h,0,-i,0,0,1,0,0,i,0,h,0,0,0,0,1]);else if(0!=g&&0==e&&0==f)d=new c([h,i,0,0,-i,h,0,0,0,0,1,0,0,0,0,1]);else{var j=a.lengthSquared;if(Math.abs(j-1)>1e-4){var k=1/Math.sqrt(j);e=a.x*k,f=a.y*k,g=a.z*k}var l=1-h;d=new c([e*e*l+h,e*f*l+g*i,e*g*l-f*i,0,e*f*l-g*i,f*f*l+h,f*g*l+e*i,0,e*g*l+f*i,f*g*l-e*i,g*g*l+h,0,0,0,0,1])}return d},c.DEG_2_RAD=Math.PI/180,c}();b.Matrix3D=c}(a.geom||(a.geom={}));a.geom}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function b(a,b,c,d){"undefined"==typeof a&&(a=0),"undefined"==typeof b&&(b=0),"undefined"==typeof c&&(c=0),"undefined"==typeof d&&(d=1),this.x=0,this.y=0,this.z=0,this.w=1,this.x=a,this.y=b,this.z=c,this.w=d}return b.lerp=function(a,c,d){return a.x*c.x+a.y*c.y+a.z*c.z+a.w*c.w<0?new b(a.x+d*(-c.x-a.x),a.y+d*(-c.y-a.y),a.z+d*(-c.z-a.z),a.w+d*(-c.w-c.w)):new b(a.x+d*(c.x-a.x),a.y+d*(c.y-a.y),a.z+d*(c.z-a.z),a.w+d*(c.w-c.w))},b.prototype.fromMatrix3D=function(a){var b,c=a.rawData[0],d=a.rawData[1],e=a.rawData[2],f=a.rawData[4],g=a.rawData[5],h=a.rawData[6],i=a.rawData[8],j=a.rawData[9],k=a.rawData[10],l=c+g+k;return l>0?(b=1/(2*Math.sqrt(l+1)),this.x=(h-j)*b,this.y=(i-e)*b,this.z=(d-f)*b,this.w=.25/b):c>g&&c>k?(b=1/(2*Math.sqrt(1+c-g+k)),this.x=(f+d)*b,this.y=(e+i)*b,this.z=(j-h)*b,this.w=.25/b):g>c&&g>k?(b=1/Math.sqrt(1+g-c-k),this.x=.25/b,this.y=(j+h)*b,this.z=(e-i)*b,this.w=(f+d)*b):k>c&&k>g&&(b=1/Math.sqrt(1+k-c-g),this.x=(j+h)*b,this.y=.25/b,this.z=(f-d)*b,this.w=(e+i)*b),this},b.prototype.toMatrix3D=function(b){"undefined"==typeof b&&(b=null);var c=this.x+this.x,d=this.y+this.y,e=this.z+this.z,f=this.x*c,g=this.x*d,h=this.x*e,i=this.y*d,j=this.y*e,k=this.z*e,l=this.w*c,m=this.w*d,n=this.w*e;return b||(b=new a.Matrix3D),b.rawData[0]=1-(i+k),b.rawData[1]=g+n,b.rawData[2]=h-m,b.rawData[3]=0,b.rawData[4]=g-n,b.rawData[5]=1-(f+k),b.rawData[6]=j+l,b.rawData[7]=0,b.rawData[8]=h+m,b.rawData[9]=j-l,b.rawData[10]=1-(f+i),b.rawData[11]=0,b.rawData[12]=0,b.rawData[13]=0,b.rawData[14]=0,b.rawData[15]=1,b},b.prototype.fromAxisAngle=function(a,b){var c=.5*b,d=Math.sin(c),e=Math.cos(c);this.x=a.x*d,this.y=a.y*d,this.z=a.z*d,this.w=e},b.prototype.conjugate=function(){this.x=-this.x,this.y=-this.y,this.z=-this.z},b.prototype.toString=function(){return"[Quaternion] (x:"+this.x+" ,y:"+this.y+", z:"+this.z+", w:"+this.w+")"},b}();a.Quaternion=b}(a.geom||(a.geom={}));a.geom}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.perspectiveFieldOfViewRH=function(a,b,c,d){var e=1/Math.tan(a/2),f=e/b;this.copyRawDataFrom([f,0,0,0,0,e,0,0,0,0,(d+c)/(c-d),-1,0,0,2*c*d/(c-d),0])},b.prototype.perspectiveFieldOfViewLH=function(a,b,c,d){var e=1/Math.tan(a/2),f=e/b;this.copyRawDataFrom([f,0,0,0,0,e,0,0,0,0,(d+c)/(d-c),1,0,0,c*d/(c-d),0])},b}(a.Matrix3D);a.PerspectiveMatrix3D=b}(a.geom||(a.geom={}));a.geom}(stageJS||(stageJS={}));var stageJS;!function(a){var b=function(){function a(){}return a.BYTES_4="bytes4",a.FLOAT_1="float1",a.FLOAT_2="float2",a.FLOAT_3="float3",a.FLOAT_4="float4",a}();a.Context3DVertexBufferFormat=b}(stageJS||(stageJS={}));var stageJS;!function(a){var b=function(){function a(){}return a.BGRA="bgra",a}();a.Context3DTextureFormat=b}(stageJS||(stageJS={}));var stageJS;!function(a){var b=function(){function a(){}return a.ALWAYS="always",a.EQUAL="equal",a.GREATER="greater",a.GREATER_EQUAL="greaterEqual",a.LESS="less",a.LESS_EQUAL="lessEqual",a.NEVER="never",a.NOT_EQUAL="notEqual",a}();a.Context3DCompareMode=b}(stageJS||(stageJS={}));var stageJS;!function(a){var b=function(){function b(){}return b.init=function(){b.ONE=a.Context3D.GL.ONE,b.ZERO=a.Context3D.GL.ZERO,b.SOURCE_COLOR=a.Context3D.GL.SRC_COLOR,b.DESTINATION_COLOR=a.Context3D.GL.DST_COLOR,b.SOURCE_ALPHA=a.Context3D.GL.SRC_ALPHA,b.DESTINATION_ALPHA=a.Context3D.GL.DST_ALPHA,b.ONE_MINUS_SOURCE_COLOR=a.Context3D.GL.ONE_MINUS_SRC_COLOR,b.ONE_MINUS_DESTINATION_COLOR=a.Context3D.GL.ONE_MINUS_DST_COLOR,b.ONE_MINUS_SOURCE_ALPHA=a.Context3D.GL.ONE_MINUS_SRC_ALPHA,b.ONE_MINUS_DESTINATION_ALPHA=a.Context3D.GL.ONE_MINUS_DST_ALPHA},b}();a.Context3DBlendFactor=b}(stageJS||(stageJS={}));var stageJS;!function(a){var b=function(){function a(){}return a.BACK="back",a.FRONT="front",a.FRONT_AND_BACK="frontAndBack",a.NONE="none",a}();a.Context3DTriangleFace=b}(stageJS||(stageJS={}));var stageJS;!function(a){var b=function(){function b(b,c){if(this._numVertices=b,this._data32PerVertex=c,this._glBuffer=a.Context3D.GL.createBuffer(),!this._glBuffer)throw new Error("Failed to create buffer")}return Object.defineProperty(b.prototype,"glBuffer",{get:function(){return this._glBuffer},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"data32PerVertex",{get:function(){return this._data32PerVertex},enumerable:!0,configurable:!0}),b.prototype.uploadFromVector=function(b,c,d){this._data=b,(0!=c||d!=this._numVertices)&&(b=b.slice(c*this._data32PerVertex,d*this._data32PerVertex)),a.Context3D.GL.bindBuffer(a.Context3D.GL.ARRAY_BUFFER,this._glBuffer),a.Context3D.GL.bufferData(a.Context3D.GL.ARRAY_BUFFER,new Float32Array(b),a.Context3D.GL.STATIC_DRAW),a.Context3D.GL.bindBuffer(a.Context3D.GL.ARRAY_BUFFER,null)},b.prototype.dispose=function(){a.Context3D.GL.deleteBuffer(this._glBuffer),this._glBuffer=null,this._data.length=0,this._numVertices=0,this._data32PerVertex=0},b}();a.VertexBuffer3D=b}(stageJS||(stageJS={}));var stageJS;!function(a){var b=function(){function b(b){this.numIndices=b,this._glBuffer=a.Context3D.GL.createBuffer()}return Object.defineProperty(b.prototype,"glBuffer",{get:function(){return this._glBuffer},enumerable:!0,configurable:!0}),b.prototype.uploadFromVector=function(b,c,d){this._data=b,(0!=c||d!=this.numIndices)&&(b=b.slice(c,c+d)),a.Context3D.GL.bindBuffer(a.Context3D.GL.ELEMENT_ARRAY_BUFFER,this._glBuffer),a.Context3D.GL.bufferData(a.Context3D.GL.ELEMENT_ARRAY_BUFFER,new Uint16Array(b),a.Context3D.GL.STATIC_DRAW),a.Context3D.GL.bindBuffer(a.Context3D.GL.ELEMENT_ARRAY_BUFFER,null)},b.prototype.dispose=function(){a.Context3D.GL.deleteBuffer(this._glBuffer),this._glBuffer=null,this.numIndices=0,this._data.length=0},b}();a.IndexBuffer3D=b}(stageJS||(stageJS={}));var stageJS;!function(a){var b=function(){function b(c,d,e,f,g){this._glTexture=a.Context3D.GL.createTexture(),this._streamingLevels=g,this._textureUnit=b.__texUnit++,this._width=c,this._height=d,this._format=e,this._forRTT=f,this._forRTT&&(a.Context3D.GL.bindTexture(a.Context3D.GL.TEXTURE_2D,this._glTexture),a.Context3D.GL.texParameteri(a.Context3D.GL.TEXTURE_2D,a.Context3D.GL.TEXTURE_MAG_FILTER,a.Context3D.GL.LINEAR),a.Context3D.GL.texParameteri(a.Context3D.GL.TEXTURE_2D,a.Context3D.GL.TEXTURE_MIN_FILTER,a.Context3D.GL.LINEAR_MIPMAP_NEAREST),a.Context3D.GL.texImage2D(a.Context3D.GL.TEXTURE_2D,0,a.Context3D.GL.RGBA,512,512,0,a.Context3D.GL.RGBA,a.Context3D.GL.UNSIGNED_BYTE,null),b._bindingTexture?a.Context3D.GL.bindTexture(a.Context3D.GL.TEXTURE_2D,b._bindingTexture):a.Context3D.GL.bindTexture(a.Context3D.GL.TEXTURE_2D,null),a.Context3D.GL.bindRenderbuffer(a.Context3D.GL.RENDERBUFFER,null),a.Context3D.GL.bindFramebuffer(a.Context3D.GL.FRAMEBUFFER,null))}return b.prototype.__getGLTexture=function(){return this._glTexture},Object.defineProperty(b.prototype,"textureUnit",{get:function(){return this._textureUnit},enumerable:!0,configurable:!0}),b.prototype.uploadFromBitmapData=function(b,c){"undefined"==typeof c&&(c=0),this._forRTT&&console.error("rtt texture"),b instanceof a.BitmapData?this.uploadFromImage(b.imageData,c):this.uploadFromImage(b,c)},b.prototype.uploadFromImage=function(c,d){if("undefined"==typeof d&&(d=0),a.Context3D.GL.activeTexture(a.Context3D.GL["TEXTURE"+this.textureUnit]),a.Context3D.GL.bindTexture(a.Context3D.GL.TEXTURE_2D,this._glTexture),b._bindingTexture=this._glTexture,0==this._streamingLevels?a.Context3D.GL.texParameteri(a.Context3D.GL.TEXTURE_2D,a.Context3D.GL.TEXTURE_MIN_FILTER,a.Context3D.GL.LINEAR):(a.Context3D.GL.texParameteri(a.Context3D.GL.TEXTURE_2D,a.Context3D.GL.TEXTURE_MIN_FILTER,a.Context3D.GL.LINEAR_MIPMAP_LINEAR),a.Context3D.GL.generateMipmap(a.Context3D.GL.TEXTURE_2D)),a.Context3D.GL.texImage2D(a.Context3D.GL.TEXTURE_2D,d,a.Context3D.GL.RGBA,a.Context3D.GL.RGBA,a.Context3D.GL.UNSIGNED_BYTE,c),!a.Context3D.GL.isTexture(this._glTexture))throw new Error("Error:Texture is invalid")},b.prototype.dispose=function(){a.Context3D.GL.bindTexture(a.Context3D.GL.TEXTURE_2D,null),b._bindingTexture=null,a.Context3D.GL.deleteTexture(this._glTexture),this._glTexture=null,this._streamingLevels=0},b.__texUnit=0,b}();a.Texture=b}(stageJS||(stageJS={}));var stageJS;!function(a){var b=function(){function b(){this._glProgram=a.Context3D.GL.createProgram()}return Object.defineProperty(b.prototype,"glProgram",{get:function(){return this._glProgram},enumerable:!0,configurable:!0}),b.prototype.dispose=function(){this._vShader&&(a.Context3D.GL.detachShader(this._glProgram,this._vShader),a.Context3D.GL.deleteShader(this._vShader),this._vShader=null),this._fShader&&(a.Context3D.GL.detachShader(this._glProgram,this._fShader),a.Context3D.GL.deleteShader(this._fShader),this._fShader=null),a.Context3D.GL.deleteProgram(this._glProgram),this._glProgram=null},b.prototype.upload=function(b,c){if("undefined"==typeof b&&(b="shader-vs"),"undefined"==typeof c&&(c="shader-fs"),this._vShader=this.loadShader(b,a.Context3D.GL.VERTEX_SHADER),this._fShader=this.loadShader(c,a.Context3D.GL.FRAGMENT_SHADER),!this._fShader||!this._vShader)throw new Error("loadShader error");a.Context3D.GL.attachShader(this._glProgram,this._vShader),a.Context3D.GL.attachShader(this._glProgram,this._fShader)},b.prototype.loadShader=function(b,c){var d=document.getElementById(b);if(!d)throw new Error("cant find elementId: "+b);var e=a.Context3D.GL.createShader(c);if(a.Context3D.GL.shaderSource(e,d.innerHTML),a.Context3D.GL.compileShader(e),!a.Context3D.GL.getShaderParameter(e,a.Context3D.GL.COMPILE_STATUS))throw new Error(a.Context3D.GL.getShaderInfoLog(e));return e},b}();a.Program3D=b}(stageJS||(stageJS={}));var stageJS;!function(a){a.VERSION=.001;var b=function(b){function c(a){b.call(this),this._context3D=null,this._stageWidth=0,this._stageHeight=0,this._canvas=a,this._stageWidth=a.width,this._stageHeight=a.height}return __extends(c,b),Object.defineProperty(c.prototype,"context3D",{get:function(){return this._context3D},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"stageWidth",{get:function(){return this._stageWidth},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"stageHeight",{get:function(){return this._stageHeight},enumerable:!0,configurable:!0}),c.prototype.requestContext3D=function(){return this._canvas?null!=this._context3D?this.onCreateSuccess():(this._canvas.addEventListener&&this._canvas.addEventListener("webglcontextcreationerror",this.onCreationError,!1),a.Context3D.GL=this.create3DContext(),null==a.Context3D.GL?this.onCreationError(null):(this._context3D=new a.Context3D,this.onCreateSuccess())):void 0},c.prototype.create3DContext=function(){for(var a=["webgl","experimental-webgl","webkit-3d","moz-webgl"],b=null,c=0;c<a.length;c++){try{b=this._canvas.getContext(a[c])}catch(d){}if(b)break}return b},c.prototype.onCreationError=function(b){"undefined"==typeof b&&(b=null),null!=b&&this._canvas.removeEventListener&&this._canvas.removeEventListener("webglcontextcreationerror",this.onCreationError,!1),this.dispatchEvent(new a.events.ErrorEvent)},c.prototype.onCreateSuccess=function(){var b=new a.events.Event(a.events.Event.CONTEXT3D_CREATE);b.target=this,this.dispatchEvent(b)},c}(a.events.EventDispatcher);a.Stage3D=b}(stageJS||(stageJS={}));var stageJS;!function(a){var b=function(){function b(){this._linkedProgram=null,this._vaCache={},this._vcCache={},this._vcMCache={},this._texCache={},b.GL.enable(b.GL.BLEND),a.Context3DBlendFactor.init()}return b.prototype.configureBackBuffer=function(a,c,d,e){"undefined"==typeof e&&(e=!0),b.GL.viewport(0,0,a,c),e?(this._clearBit=b.GL.COLOR_BUFFER_BIT|b.GL.DEPTH_BUFFER_BIT|b.GL.STENCIL_BUFFER_BIT,b.GL.enable(b.GL.DEPTH_TEST),b.GL.enable(b.GL.STENCIL_TEST)):(this._clearBit=b.GL.COLOR_BUFFER_BIT,b.GL.disable(b.GL.DEPTH_TEST),b.GL.disable(b.GL.STENCIL_TEST))},b.prototype.createVertexBuffer=function(b,c){return new a.VertexBuffer3D(b,c)},b.prototype.createIndexBuffer=function(b){return new a.IndexBuffer3D(b)},b.prototype.createTexture=function(b,c,d,e,f){return"undefined"==typeof f&&(f=0),new a.Texture(b,c,d,e,f)},b.prototype.setRenderToTexture=function(a,c,d,e,f){if("undefined"==typeof c&&(c=!1),"undefined"==typeof d&&(d=0),"undefined"==typeof e&&(e=0),"undefined"==typeof f&&(f=0),c?(this._clearBit=b.GL.COLOR_BUFFER_BIT|b.GL.DEPTH_BUFFER_BIT|b.GL.STENCIL_BUFFER_BIT,b.GL.enable(b.GL.DEPTH_TEST),b.GL.enable(b.GL.STENCIL_TEST)):(this._clearBit=b.GL.COLOR_BUFFER_BIT,b.GL.disable(b.GL.DEPTH_TEST),b.GL.disable(b.GL.STENCIL_TEST)),!this._rttFramebuffer){this._rttFramebuffer=b.GL.createFramebuffer(),b.GL.bindFramebuffer(b.GL.FRAMEBUFFER,this._rttFramebuffer);var g=b.GL.createRenderbuffer();b.GL.bindRenderbuffer(b.GL.RENDERBUFFER,g),b.GL.renderbufferStorage(b.GL.RENDERBUFFER,b.GL.DEPTH_COMPONENT16,512,512),b.GL.framebufferRenderbuffer(b.GL.FRAMEBUFFER,b.GL.DEPTH_ATTACHMENT,b.GL.RENDERBUFFER,g),b.GL.framebufferTexture2D(b.GL.FRAMEBUFFER,b.GL.COLOR_ATTACHMENT0,b.GL.TEXTURE_2D,a.__getGLTexture(),0)}b.GL.bindFramebuffer(b.GL.FRAMEBUFFER,this._rttFramebuffer)},b.prototype.setRenderToBackBuffer=function(){b.GL.bindFramebuffer(b.GL.FRAMEBUFFER,null)},b.prototype.createProgram=function(){return new a.Program3D},b.prototype.setVertexBufferAt=function(b,c,d,e){"undefined"==typeof d&&(d=0),"undefined"==typeof e&&(e="float4");var f=0;switch(e){case a.Context3DVertexBufferFormat.FLOAT_4:f=4;break;case a.Context3DVertexBufferFormat.FLOAT_3:f=3;break;case a.Context3DVertexBufferFormat.FLOAT_2:f=2;break;case a.Context3DVertexBufferFormat.FLOAT_1:f=1;break;case a.Context3DVertexBufferFormat.BYTES_4:f=4}if(0>=f)throw new Error("vertexBuffer format error");this._vaCache[b]={size:f,buffer:c.glBuffer,stride:4*c.data32PerVertex,offset:4*d},this._linkedProgram&&this.enableVA(b)},b.prototype.setProgramConstantsFromVector=function(a,b){if(b.length>4)throw new Error("data length > 4");this._vcCache[a]=b,this._linkedProgram&&this.enableVC(a)
},b.prototype.setProgramConstantsFromMatrix=function(a,b,c){"undefined"==typeof c&&(c=!1),c&&b.transpose(),this._vcMCache[a]=b.rawData,this._linkedProgram&&this.enableVCM(a)},b.prototype.setTextureAt=function(a,b){this._texCache[a]=b,this._linkedProgram&&this.enableTex(a)},b.prototype.setProgram=function(a){if(null!=a&&a!=this._linkedProgram){if(this._linkedProgram=a,b.GL.linkProgram(a.glProgram),!b.GL.getProgramParameter(a.glProgram,b.GL.LINK_STATUS))throw new Error(b.GL.getProgramInfoLog(a.glProgram));b.GL.useProgram(a.glProgram);var c;for(c in this._vaCache)this.enableVA(c);for(c in this._vcCache)this.enableVC(c);for(c in this._vcMCache)this.enableVCM(c);for(c in this._texCache)this.enableTex(c)}},b.prototype.clear=function(a,c,d,e,f,g,h){"undefined"==typeof a&&(a=0),"undefined"==typeof c&&(c=0),"undefined"==typeof d&&(d=0),"undefined"==typeof e&&(e=1),"undefined"==typeof f&&(f=1),"undefined"==typeof g&&(g=0),"undefined"==typeof h&&(h=4294967295),b.GL.clearColor(a,c,d,e),b.GL.clearDepth(f),b.GL.clearStencil(g),b.GL.clear(this._clearBit)},b.prototype.setCulling=function(c){switch(b.GL.frontFace(b.GL.CW),c){case a.Context3DTriangleFace.NONE:b.GL.disable(b.GL.CULL_FACE);break;case a.Context3DTriangleFace.BACK:b.GL.enable(b.GL.CULL_FACE),b.GL.cullFace(b.GL.BACK);break;case a.Context3DTriangleFace.FRONT:b.GL.enable(b.GL.CULL_FACE),b.GL.cullFace(b.GL.FRONT);break;case a.Context3DTriangleFace.FRONT_AND_BACK:b.GL.enable(b.GL.CULL_FACE),b.GL.cullFace(b.GL.FRONT_AND_BACK)}},b.prototype.setDepthTest=function(c,d){switch(b.GL.depthMask(c),d){case a.Context3DCompareMode.LESS:b.GL.depthFunc(b.GL.LESS);break;case a.Context3DCompareMode.NEVER:b.GL.depthFunc(b.GL.NEVER);break;case a.Context3DCompareMode.EQUAL:b.GL.depthFunc(b.GL.EQUAL);break;case a.Context3DCompareMode.GREATER:b.GL.depthFunc(b.GL.GREATER);break;case a.Context3DCompareMode.NOT_EQUAL:b.GL.depthFunc(b.GL.NOTEQUAL);break;case a.Context3DCompareMode.ALWAYS:b.GL.depthFunc(b.GL.ALWAYS);break;case a.Context3DCompareMode.LESS_EQUAL:b.GL.depthFunc(b.GL.LEQUAL);break;case a.Context3DCompareMode.GREATER_EQUAL:b.GL.depthFunc(b.GL.GEQUAL)}},b.prototype.setBlendFactors=function(a,c){b.GL.blendFunc(a,c)},b.prototype.drawTriangles=function(a,c,d){"undefined"==typeof c&&(c=0),"undefined"==typeof d&&(d=-1),b.GL.bindBuffer(b.GL.ELEMENT_ARRAY_BUFFER,a.glBuffer),b.GL.drawElements(b.GL.TRIANGLES,0>d?a.numIndices:3*d,b.GL.UNSIGNED_SHORT,2*c)},b.prototype.drawLines=function(a,c,d){"undefined"==typeof c&&(c=0),"undefined"==typeof d&&(d=-1),b.GL.bindBuffer(b.GL.ELEMENT_ARRAY_BUFFER,a.glBuffer),b.GL.drawElements(b.GL.LINES,0>d?a.numIndices:2*d,b.GL.UNSIGNED_SHORT,2*c)},b.prototype.drawPoints=function(a,c,d){"undefined"==typeof c&&(c=0),"undefined"==typeof d&&(d=-1),b.GL.bindBuffer(b.GL.ELEMENT_ARRAY_BUFFER,a.glBuffer),b.GL.drawElements(b.GL.POINTS,0>d?a.numIndices:d,b.GL.UNSIGNED_SHORT,2*c)},b.prototype.drawLineLoop=function(a,c,d){"undefined"==typeof c&&(c=0),"undefined"==typeof d&&(d=-1),b.GL.bindBuffer(b.GL.ELEMENT_ARRAY_BUFFER,a.glBuffer),b.GL.drawElements(b.GL.LINE_LOOP,0>d?a.numIndices:d,b.GL.UNSIGNED_SHORT,2*c)},b.prototype.drawLineStrip=function(a,c,d){"undefined"==typeof c&&(c=0),"undefined"==typeof d&&(d=-1),b.GL.bindBuffer(b.GL.ELEMENT_ARRAY_BUFFER,a.glBuffer),b.GL.drawElements(b.GL.LINE_STRIP,0>d?a.numIndices:d,b.GL.UNSIGNED_SHORT,2*c)},b.prototype.drawTriangleStrip=function(a){b.GL.bindBuffer(b.GL.ELEMENT_ARRAY_BUFFER,a.glBuffer),b.GL.drawElements(b.GL.TRIANGLE_STRIP,a.numIndices,b.GL.UNSIGNED_SHORT,0)},b.prototype.drawTriangleFan=function(a){b.GL.bindBuffer(b.GL.ELEMENT_ARRAY_BUFFER,a.glBuffer),b.GL.drawElements(b.GL.TRIANGLE_FAN,a.numIndices,b.GL.UNSIGNED_SHORT,0)},b.prototype.present=function(){},b.prototype.enableVA=function(a){var c=b.GL.getAttribLocation(this._linkedProgram.glProgram,a);if(0>c)throw new Error("Fail to get the storage location of"+a);var d=this._vaCache[a];b.GL.bindBuffer(b.GL.ARRAY_BUFFER,d.buffer),b.GL.vertexAttribPointer(c,d.size,b.GL.FLOAT,!1,d.stride,d.offset),b.GL.enableVertexAttribArray(c)},b.prototype.enableVC=function(a){var c=b.GL.getUniformLocation(this._linkedProgram.glProgram,a);if(!c)throw new Error("Fail to get uniform "+a);var d=this._vcCache[a];b.GL["uniform"+d.length+"fv"](c,d)},b.prototype.enableVCM=function(a){var c=b.GL.getUniformLocation(this._linkedProgram.glProgram,a);if(!c)throw new Error("Fail to get uniform "+a);b.GL.uniformMatrix4fv(c,!1,this._vcMCache[a])},b.prototype.enableTex=function(a){var c=this._texCache[a];b.GL.activeTexture(b.GL["TEXTURE"+c.textureUnit]);var d=b.GL.getUniformLocation(this._linkedProgram.glProgram,a);b.GL.uniform1i(d,c.textureUnit)},b}();a.Context3D=b}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function a(){this.position=0,this.length=0,this._mode=""}return a.prototype.writeByte=function(){throw"Virtual method"},a.prototype.readByte=function(){throw"Virtual method"},a.prototype.writeUnsignedByte=function(){throw"Virtual method"},a.prototype.readUnsignedByte=function(){throw"Virtual method"},a.prototype.writeUnsignedShort=function(){throw"Virtual method"},a.prototype.readUnsignedShort=function(){throw"Virtual method"},a.prototype.writeUnsignedInt=function(){throw"Virtual method"},a.prototype.readUnsignedInt=function(){throw"Virtual method"},a.prototype.writeFloat=function(){throw"Virtual method"},a.prototype.toFloatBits=function(){throw"Virtual method"},a.prototype.readFloat=function(){throw"Virtual method"},a.prototype.fromFloatBits=function(){throw"Virtual method"},a.prototype.getBytesAvailable=function(){throw new Error("not implemented")},a.prototype.toString=function(){return"[ByteArray] ( "+this._mode+" ) position="+this.position+" length="+this.length},a.prototype.compareEqual=function(a,b){(null==b||b>this.length-this.position)&&(b=this.length-this.position),b>a.length-a.position&&(b=a.length-a.position);for(var c=!0;c&&b>=4;)b-=4,this.readUnsignedInt()!=a.readUnsignedInt()&&(c=!1);for(;c&&b>=1;)b--,this.readUnsignedByte()!=a.readUnsignedByte()&&(c=!1);var d;return this.position-=d-b,a.position-=d-b,c},a.prototype.writeBase64String=function(a){for(var b=0;b<a.length;b++){a.charAt(b)}},a.prototype.dumpToConsole=function(){function a(a,b){for(var c=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],d="",e=0;b>e;e++)d=c[a>>(e<<2)&15]+d;return d}var b=this.position;this.position=0;for(var c=8,d=0;d<this.length;d+=c){for(var e=a(d,4)+":",f=0;c>f&&d+f<this.length;f++)e+=" "+a(this.readUnsignedByte(),2);console.log(e)}this.position=b},a.prototype.readBase64String=function(b){return(null==b||b>this.length-this.position)&&(b=this.length-this.position),b>0?a.internalGetBase64String(b,this.readUnsignedByte,this):""},a.internalGetBase64String=function(b,c,d){for(var e,f,g,h,i,j,k,l="",m=a.Base64Key;b>=3;)e=c.apply(d),f=c.apply(d),g=c.apply(d),h=e>>2,i=(3&e)<<4|f>>4,j=(15&f)<<2|g>>6,k=63&g,l+=m.charAt(h)+m.charAt(i)+m.charAt(j)+m.charAt(k),b-=3;return 2==b?(e=c.apply(d),f=c.apply(d),h=e>>2,i=(3&e)<<4|f>>4,j=(15&f)<<2,l+=m.charAt(h)+m.charAt(i)+m.charAt(j)+"="):1==b&&(e=c.apply(d),h=e>>2,i=(3&e)<<4,l+=m.charAt(h)+m.charAt(i)+"=="),l},a.Base64Key="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a}();a.ByteArrayBase=b}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(a){function b(){a.call(this),this.maxlength=0,this._mode="Typed array",this.maxlength=4,this.arraybytes=new ArrayBuffer(this.maxlength),this.unalignedarraybytestemp=new ArrayBuffer(16)}return __extends(b,a),b.prototype.ensureWriteableSpace=function(a){this.ensureSpace(a+this.position)},b.prototype.setArrayBuffer=function(a){this.ensureSpace(a.byteLength),this.length=a.byteLength;var b=new Int8Array(a),c=new Int8Array(this.arraybytes,0,this.length);c.set(b),this.position=0},b.prototype.getBytesAvailable=function(){return this.length-this.position},b.prototype.ensureSpace=function(a){if(a>this.maxlength){var b=a+255&-256,c=new ArrayBuffer(b),d=new Uint8Array(this.arraybytes,0,this.length),e=new Uint8Array(c,0,this.length);e.set(d),this.arraybytes=c,this.maxlength=b}},b.prototype.writeByte=function(a){this.ensureWriteableSpace(1);var b=new Int8Array(this.arraybytes);b[this.position++]=~~a,this.position>this.length&&(this.length=this.position)},b.prototype.readByte=function(){if(this.position>=this.length)throw"ByteArray out of bounds read. Positon="+this.position+", Length="+this.length;var a=new Int8Array(this.arraybytes);return a[this.position++]},b.prototype.readBytes=function(a,b,c){"undefined"==typeof b&&(b=0),"undefined"==typeof c&&(c=0),null==c&&(c=a.length),a.ensureWriteableSpace(b+c);var d=new Int8Array(a.arraybytes),e=new Int8Array(this.arraybytes);d.set(e.subarray(this.position,this.position+c),b),this.position+=c,c+b>a.length&&(a.length+=c+b-a.length)},b.prototype.writeUnsignedByte=function(a){this.ensureWriteableSpace(1);var b=new Uint8Array(this.arraybytes);b[this.position++]=255&~~a,this.position>this.length&&(this.length=this.position)},b.prototype.readUnsignedByte=function(){if(this.position>=this.length)throw"ByteArray out of bounds read. Positon="+this.position+", Length="+this.length;var a=new Uint8Array(this.arraybytes);return a[this.position++]},b.prototype.writeUnsignedShort=function(a){if(this.ensureWriteableSpace(2),0==(1&this.position)){var b=new Uint16Array(this.arraybytes);b[this.position>>1]=65535&~~a}else{var b=new Uint16Array(this.unalignedarraybytestemp,0,1);b[0]=65535&~~a;var c=new Uint8Array(this.arraybytes,this.position,2),d=new Uint8Array(this.unalignedarraybytestemp,0,2);c.set(d)}this.position+=2,this.position>this.length&&(this.length=this.position)},b.prototype.readUTFBytes=function(a){for(var b="",c=this.position+a,d=new DataView(this.arraybytes);this.position<c;){var e=d.getUint8(this.position++);if(128>e){if(0==e)break;b+=String.fromCharCode(e)}else if(224>e)b+=String.fromCharCode((63&e)<<6|127&d.getUint8(this.position++));else if(240>e){var f=d.getUint8(this.position++);b+=String.fromCharCode((31&e)<<12|(127&f)<<6|127&d.getUint8(this.position++))}else{var f=d.getUint8(this.position++),g=d.getUint8(this.position++);b+=String.fromCharCode((15&e)<<18|(127&f)<<12|g<<6&127|127&d.getUint8(this.position++))}}return b},b.prototype.readInt=function(){var a=new DataView(this.arraybytes),b=a.getInt32(this.position,!0);return this.position+=4,b},b.prototype.readShort=function(){var a=new DataView(this.arraybytes),b=a.getInt16(this.position,!0);return this.position+=2,b},b.prototype.readDouble=function(){var a=new DataView(this.arraybytes),b=a.getFloat64(this.position,!0);return this.position+=8,b},b.prototype.readUnsignedShort=function(){if(this.position>this.length+2)throw"ByteArray out of bounds read. Position="+this.position+", Length="+this.length;if(0==(1&this.position)){var a=new Uint16Array(this.arraybytes),b=this.position>>1;return this.position+=2,a[b]}var a=new Uint16Array(this.unalignedarraybytestemp,0,1),c=new Uint8Array(this.arraybytes,this.position,2),d=new Uint8Array(this.unalignedarraybytestemp,0,2);return d.set(c),this.position+=2,a[0]},b.prototype.writeUnsignedInt=function(a){if(this.ensureWriteableSpace(4),0==(3&this.position)){var b=new Uint32Array(this.arraybytes);b[this.position>>2]=4294967295&~~a}else{var b=new Uint32Array(this.unalignedarraybytestemp,0,1);b[0]=4294967295&~~a;var c=new Uint8Array(this.arraybytes,this.position,4),d=new Uint8Array(this.unalignedarraybytestemp,0,4);c.set(d)}this.position+=4,this.position>this.length&&(this.length=this.position)},b.prototype.readUnsignedInt=function(){if(this.position>this.length+4)throw"ByteArray out of bounds read. Position="+this.position+", Length="+this.length;if(0==(3&this.position)){var a=new Uint32Array(this.arraybytes),b=this.position>>2;return this.position+=4,a[b]}var a=new Uint32Array(this.unalignedarraybytestemp,0,1),c=new Uint8Array(this.arraybytes,this.position,4),d=new Uint8Array(this.unalignedarraybytestemp,0,4);return d.set(c),this.position+=4,a[0]},b.prototype.writeFloat=function(a){if(this.ensureWriteableSpace(4),0==(3&this.position)){var b=new Float32Array(this.arraybytes);b[this.position>>2]=a}else{var b=new Float32Array(this.unalignedarraybytestemp,0,1);b[0]=a;var c=new Uint8Array(this.arraybytes,this.position,4),d=new Uint8Array(this.unalignedarraybytestemp,0,4);c.set(d)}this.position+=4,this.position>this.length&&(this.length=this.position)},b.prototype.readFloat=function(){if(this.position>this.length+4)throw"ByteArray out of bounds read. Positon="+this.position+", Length="+this.length;if(0==(3&this.position)){var a=new Float32Array(this.arraybytes),b=this.position>>2;return this.position+=4,a[b]}var a=new Float32Array(this.unalignedarraybytestemp,0,1),c=new Uint8Array(this.arraybytes,this.position,4),d=new Uint8Array(this.unalignedarraybytestemp,0,4);return d.set(c),this.position+=4,a[0]},b}(a.ByteArrayBase);a.ByteArray=b}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){!function(a){var b=function(){function a(){}return a}();a.Flags=b}(a.assembler||(a.assembler={}));a.assembler}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){!function(a){var b=function(){function a(){}return a}();a.FS=b}(a.assembler||(a.assembler={}));a.assembler}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){!function(a){var b=function(){function b(b,c,d,e,f,g,h,i,j,k){this.a=new a.FS,this.b=new a.FS,this.flags=new a.Flags,this.dest=b,this.a.format=c,this.a.size=d,this.b.format=e,this.b.size=f,this.opcode=g,this.flags.simple=h,this.flags.horizontal=i,this.flags.fragonly=j,this.flags.matrix=k}return b}();a.Opcode=b}(a.assembler||(a.assembler={}));a.assembler}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){!function(a){var b=function(){function b(){}return Object.defineProperty(b,"map",{get:function(){return b._map||(b._map=new Array,b._map.mov=new a.Opcode("vector","vector",4,"none",0,0,!0,null,null,null),b._map.add=new a.Opcode("vector","vector",4,"vector",4,1,!0,null,null,null),b._map.sub=new a.Opcode("vector","vector",4,"vector",4,2,!0,null,null,null),b._map.mul=new a.Opcode("vector","vector",4,"vector",4,3,!0,null,null,null),b._map.div=new a.Opcode("vector","vector",4,"vector",4,4,!0,null,null,null),b._map.rcp=new a.Opcode("vector","vector",4,"none",0,5,!0,null,null,null),b._map.min=new a.Opcode("vector","vector",4,"vector",4,6,!0,null,null,null),b._map.max=new a.Opcode("vector","vector",4,"vector",4,7,!0,null,null,null),b._map.frc=new a.Opcode("vector","vector",4,"none",0,8,!0,null,null,null),b._map.sqt=new a.Opcode("vector","vector",4,"none",0,9,!0,null,null,null),b._map.rsq=new a.Opcode("vector","vector",4,"none",0,10,!0,null,null,null),b._map.pow=new a.Opcode("vector","vector",4,"vector",4,11,!0,null,null,null),b._map.log=new a.Opcode("vector","vector",4,"none",0,12,!0,null,null,null),b._map.exp=new a.Opcode("vector","vector",4,"none",0,13,!0,null,null,null),b._map.nrm=new a.Opcode("vector","vector",4,"none",0,14,!0,null,null,null),b._map.sin=new a.Opcode("vector","vector",4,"none",0,15,!0,null,null,null),b._map.cos=new a.Opcode("vector","vector",4,"none",0,16,!0,null,null,null),b._map.crs=new a.Opcode("vector","vector",4,"vector",4,17,!0,!0,null,null),b._map.dp3=new a.Opcode("vector","vector",4,"vector",4,18,!0,!0,null,null),b._map.dp4=new a.Opcode("vector","vector",4,"vector",4,19,!0,!0,null,null),b._map.abs=new a.Opcode("vector","vector",4,"none",0,20,!0,null,null,null),b._map.neg=new a.Opcode("vector","vector",4,"none",0,21,!0,null,null,null),b._map.sat=new a.Opcode("vector","vector",4,"none",0,22,!0,null,null,null),b._map.ted=new a.Opcode("vector","vector",4,"sampler",1,38,!0,null,!0,null),b._map.kil=new a.Opcode("none","scalar",1,"none",0,39,!0,null,!0,null),b._map.tex=new a.Opcode("vector","vector",4,"sampler",1,40,!0,null,!0,null),b._map.m33=new a.Opcode("vector","matrix",3,"vector",3,23,!0,null,null,!0),b._map.m44=new a.Opcode("vector","matrix",4,"vector",4,24,!0,null,null,!0),b._map.m43=new a.Opcode("vector","matrix",3,"vector",4,25,!0,null,null,!0),b._map.sge=new a.Opcode("vector","vector",4,"vector",4,41,!0,null,null,null),b._map.slt=new a.Opcode("vector","vector",4,"vector",4,42,!0,null,null,null),b._map.sgn=new a.Opcode("vector","vector",4,"vector",4,43,!0,null,null,null),b._map.seq=new a.Opcode("vector","vector",4,"vector",4,44,!0,null,null,null),b._map.sne=new a.Opcode("vector","vector",4,"vector",4,45,!0,null,null,null)),b._map},enumerable:!0,configurable:!0}),b}();a.OpcodeMap=b}(a.assembler||(a.assembler={}));a.assembler}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){!function(b){var c=function(){function b(b,c){"undefined"==typeof b&&(b=null),"undefined"==typeof c&&(c=null),this.name="",this.version=0,this.name=b,this.version=c,this.data=new a.ByteArray}return b}();b.Part=c}(a.assembler||(a.assembler={}));a.assembler}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){!function(a){var b=function(){function a(a,b){this.code=a,this.desc=b}return a}(),c=function(){function a(){}return Object.defineProperty(a,"map",{get:function(){return a._map||(a._map=new Array,a._map.va=new b(0,"vertex attribute"),a._map.fc=new b(1,"fragment constant"),a._map.vc=new b(1,"vertex constant"),a._map.ft=new b(2,"fragment temporary"),a._map.vt=new b(2,"vertex temporary"),a._map.vo=new b(3,"vertex output"),a._map.op=new b(3,"vertex output"),a._map.fd=new b(3,"fragment depth output"),a._map.fo=new b(3,"fragment output"),a._map.oc=new b(3,"fragment output"),a._map.v=new b(4,"varying"),a._map.vi=new b(4,"varying output"),a._map.fi=new b(4,"varying input"),a._map.fs=new b(5,"sampler")),a._map},enumerable:!0,configurable:!0}),a}();a.RegMap=c}(a.assembler||(a.assembler={}));a.assembler}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){!function(a){var b=function(){function a(a,b,c){this.shift=a,this.mask=b,this.value=c}return a}();a.Sampler=b}(a.assembler||(a.assembler={}));a.assembler}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){!function(a){var b=function(){function b(){}return Object.defineProperty(b,"map",{get:function(){return b._map||(b._map=new Array,b._map.rgba=new a.Sampler(8,15,0),b._map.rg=new a.Sampler(8,15,5),b._map.r=new a.Sampler(8,15,4),b._map.compressed=new a.Sampler(8,15,1),b._map.compressed_alpha=new a.Sampler(8,15,2),b._map.dxt1=new a.Sampler(8,15,1),b._map.dxt5=new a.Sampler(8,15,2),b._map["2d"]=new a.Sampler(12,15,0),b._map.cube=new a.Sampler(12,15,1),b._map["3d"]=new a.Sampler(12,15,2),b._map.centroid=new a.Sampler(16,1,1),b._map.ignoresampler=new a.Sampler(16,4,4),b._map.clamp=new a.Sampler(20,15,0),b._map.repeat=new a.Sampler(20,15,1),b._map.wrap=new a.Sampler(20,15,1),b._map.nomip=new a.Sampler(24,15,0),b._map.mipnone=new a.Sampler(24,15,0),b._map.mipnearest=new a.Sampler(24,15,1),b._map.miplinear=new a.Sampler(24,15,2),b._map.nearest=new a.Sampler(28,15,0),b._map.linear=new a.Sampler(28,15,1)),b._map},enumerable:!0,configurable:!0}),b}();a.SamplerMap=b}(a.assembler||(a.assembler={}));a.assembler}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){!function(a){var b=function(){function b(){this.r={},this.cur=new a.Part}return b.prototype.assemble=function(a,b,c){"undefined"==typeof b&&(b=null),"undefined"==typeof c&&(c=null),c||(c=1),b&&this.addHeader(b,c);var d=a.replace(/[\f\n\r\v]+/g,"\n").split("\n");for(var e in d)this.processLine(d[e],e);return this.r},b.prototype.processLine=function(b,c){var d=b.search("//");if(-1!=d&&(b=b.slice(0,d)),b=b.replace(/^\s+|\s+$/g,""),b.length>0){var e=b.search(/<.*>/g),f=null;-1!=e&&(f=b.slice(e).match(/([\w\.\-\+]+)/gi),b=b.slice(0,e));var g=b.match(/([\w\.\+\[\]]+)/gi);if(!g||g.length<1)return void(b.length>=3&&console.log("Warning: bad line "+c+": "+b));switch(g[0]){case"part":this.addHeader(g[1],Number(g[2]));break;case"endpart":if(!this.cur)throw"Unexpected endpart";return this.cur.data.position=0,void(this.cur=null);default:if(!this.cur)return void console.log("Warning: bad line "+c+": "+b+" (Outside of any part definition)");if("comment"==this.cur.name)return;var h=a.OpcodeMap.map[g[0]];if(!h)throw"Bad opcode "+g[0]+" "+c+": "+b;this.emitOpcode(this.cur,h.opcode);var i=1;if(h.dest&&"none"!=h.dest){if(!this.emitDest(this.cur,g[i++],h.dest))throw"Bad destination register "+g[i-1]+" "+c+": "+b}else this.emitZeroDword(this.cur);if(h.a&&"none"!=h.a.format){if(!this.emitSource(this.cur,g[i++],h.a))throw"Bad source register "+g[i-1]+" "+c+": "+b}else this.emitZeroQword(this.cur);if(h.b&&"none"!=h.b.format){if("sampler"==h.b.format){if(!this.emitSampler(this.cur,g[i++],h.b,f))throw"Bad sampler register "+g[i-1]+" "+c+": "+b}else if(!this.emitSource(this.cur,g[i++],h.b))throw"Bad source register "+g[i-1]+" "+c+": "+b}else this.emitZeroQword(this.cur)}}},b.prototype.emitHeader=function(a){switch(a.data.writeUnsignedByte(160),a.data.writeUnsignedInt(a.version),a.version>=16&&a.data.writeUnsignedByte(0),a.data.writeUnsignedByte(161),a.name){case"fragment":a.data.writeUnsignedByte(1);break;case"vertex":a.data.writeUnsignedByte(0);break;case"cpu":a.data.writeUnsignedByte(2);break;default:a.data.writeUnsignedByte(255)}},b.prototype.emitOpcode=function(a,b){a.data.writeUnsignedInt(b)},b.prototype.emitZeroDword=function(a){a.data.writeUnsignedInt(0)},b.prototype.emitZeroQword=function(a){a.data.writeUnsignedInt(0),a.data.writeUnsignedInt(0)},b.prototype.emitDest=function(b,c){var d=c.match(/([fov]?[tpocidavs])(\d*)(\.[xyzw]{1,4})?/i);if(console.log("AGALMiniAssembler","emitDest","reg",d,d[1],a.RegMap.map[d[1]]),!a.RegMap.map[d[1]])return!1;var e={num:d[2]?d[2]:0,code:a.RegMap.map[d[1]].code,mask:this.stringToMask(d[3])};return b.data.writeUnsignedShort(e.num),b.data.writeUnsignedByte(e.mask),b.data.writeUnsignedByte(e.code),!0},b.prototype.stringToMask=function(a){if(!a)return 15;var b=0;return-1!=a.indexOf("x")&&(b|=1),-1!=a.indexOf("y")&&(b|=2),-1!=a.indexOf("z")&&(b|=4),-1!=a.indexOf("w")&&(b|=8),b},b.prototype.stringToSwizzle=function(a){if(!a)return 228;var b={x:0,y:1,z:2,w:3},c=0;if("."!=a.charAt(0))throw"Missing . for swizzle";return a.length>1&&(c|=b[a.charAt(1)]),c|=a.length>2?b[a.charAt(2)]<<2:(3&c)<<2,c|=a.length>3?b[a.charAt(3)]<<4:(12&c)<<2,c|=a.length>4?b[a.charAt(4)]<<6:(48&c)<<2},b.prototype.emitSampler=function(b,c,d,e){var f=c.match(/fs(\d*)/i);if(!f||!f[1])return!1;b.data.writeUnsignedShort(parseInt(f[1])),b.data.writeUnsignedByte(0),b.data.writeUnsignedByte(0);for(var g=5,h=0,i=0;i<e.length;i++){var j=a.SamplerMap.map[e[i].toLowerCase()];j?(0!=(h>>j.shift&j.mask)&&console.log("Warning, duplicate sampler option"),h|=j.mask<<j.shift,g&=~(j.mask<<j.shift),g|=j.value<<j.shift):console.log("Warning, unknown sampler option: ",e[i])}return b.data.writeUnsignedInt(g),!0},b.prototype.emitSource=function(b,c){var d,e=c.match(/vc\[(v[tcai])(\d+)\.([xyzw])([\+\-]\d+)?\](\.[xyzw]{1,4})?/i);if(e){if(!a.RegMap.map[e[1]])return!1;var f={x:0,y:1,z:2,w:3},g={num:0|e[2],code:a.RegMap.map[e[1]].code,swizzle:this.stringToSwizzle(e[5]),select:f[e[3]],offset:0|e[4]};b.data.writeUnsignedShort(g.num),b.data.writeByte(g.offset),b.data.writeUnsignedByte(g.swizzle),b.data.writeUnsignedByte(1),b.data.writeUnsignedByte(g.code),b.data.writeUnsignedByte(g.select),b.data.writeUnsignedByte(128)}else{if(d=c.match(/([fov]?[tpocidavs])(\d*)(\.[xyzw]{1,4})?/i),!a.RegMap.map[d[1]])return!1;var g={num:0|d[2],code:a.RegMap.map[d[1]].code,swizzle:this.stringToSwizzle(d[3])};b.data.writeUnsignedShort(g.num),b.data.writeUnsignedByte(0),b.data.writeUnsignedByte(g.swizzle),b.data.writeUnsignedByte(g.code),b.data.writeUnsignedByte(0),b.data.writeUnsignedByte(0),b.data.writeUnsignedByte(0)}return!0},b.prototype.addHeader=function(b,c){if(c||(c=1),null==this.r[b])this.r[b]=new a.Part(b,c),this.emitHeader(this.r[b]);else if(this.r[b].version!=c)throw"Multiple versions for part "+b;this.cur=this.r[b]},b}();a.AGALMiniAssembler=b}(a.assembler||(a.assembler={}));a.assembler}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function a(){this.progid=0,this.version=0,this.type=""}return a}();a.Header=b}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function a(){this.mask=0,this.regnum=0,this.regtype=0,this.dim=0}return a}();a.Destination=b}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function b(){this.dest=new a.Destination,this.opcode=0,this.a=new a.Destination,this.b=new a.Destination}return b}();a.Token=b}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function b(){this.regread=[[],[],[],[],[],[],[]],this.regwrite=[[],[],[],[],[],[],[]],this.hasindirect=!1,this.writedepth=!1,this.hasmatrix=!1,this.samplers=[],this.tokens=[],this.header=new a.Header}return b}();a.Description=b}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function a(a,b,c,d,e,f,g,h,i,j,k){this.s=a,this.flags=b,this.dest=c,this.a=d,this.b=e,this.matrixwidth=f,this.matrixheight=g,this.ndwm=h,this.scalar=i,this.dm=j,this.lod=k}return a}();a.OpLUT=b}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function b(){}return b.agal2glsllut=[new a.OpLUT("%dest = %cast(%a);\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(%a + %b);\n",0,!0,!0,!0,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(%a - %b);\n",0,!0,!0,!0,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(%a * %b);\n",0,!0,!0,!0,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(%a / %b);\n",0,!0,!0,!0,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(1.0) / %a;\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(min(%a,%b));\n",0,!0,!0,!0,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(max(%a,%b));\n",0,!0,!0,!0,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(fract(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(sqrt(abs(%a)));\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(inversesqrt(abs(%a)));\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(pow(abs(%a),%b));\n",0,!0,!0,!0,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(log2(abs(%a)));\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(exp2(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(normalize(vec3( %a ) ));\n",0,!0,!0,!1,null,null,!0,null,null,null),new a.OpLUT("%dest = %cast(sin(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(cos(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(cross(vec3(%a),vec3(%b)));\n",0,!0,!0,!0,null,null,!0,null,null,null),new a.OpLUT("%dest = %cast(dot(vec3(%a),vec3(%b)));\n",0,!0,!0,!0,null,null,!0,null,null,null),new a.OpLUT("%dest = %cast(dot(vec4(%a),vec4(%b)));\n",0,!0,!0,!0,null,null,!0,null,null,null),new a.OpLUT("%dest = %cast(abs(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(%a * -1.0);\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(clamp(%a,0.0,1.0));\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(dot(vec3(%a),vec3(%b)));\n",null,!0,!0,!0,3,3,!0,null,null,null),new a.OpLUT("%dest = %cast(dot(vec4(%a),vec4(%b)));\n",null,!0,!0,!0,4,4,!0,null,null,null),new a.OpLUT("%dest = %cast(dot(vec4(%a),vec4(%b)));\n",null,!0,!0,!0,4,3,!0,null,null,null),new a.OpLUT("%dest = %cast(dFdx(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(dFdx(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("if (float(%a)==float(%b)) {;\n",0,!1,!0,!0,null,null,null,!0,null,null),new a.OpLUT("if (float(%a)!=float(%b)) {;\n",0,!1,!0,!0,null,null,null,!0,null,null),new a.OpLUT("if (float(%a)>=float(%b)) {;\n",0,!1,!0,!0,null,null,null,!0,null,null),new a.OpLUT("if (float(%a)<float(%b)) {;\n",0,!1,!0,!0,null,null,null,!0,null,null),new a.OpLUT("} else {;\n",0,!1,!1,!1,null,null,null,null,null,null),new a.OpLUT("};\n",0,!1,!1,!1,null,null,null,null,null,null),new a.OpLUT(null,null,null,null,!1,null,null,null,null,null,null),new a.OpLUT(null,null,null,null,!1,null,null,null,null,null,null),new a.OpLUT(null,null,null,null,!1,null,null,null,null,null,null),new a.OpLUT(null,null,null,null,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(texture%texdimLod(%b,%texsize(%a)).%dm);\n",null,!0,!0,!0,null,null,null,null,!0,null),new a.OpLUT("if ( float(%a)<0.0 ) discard;\n",null,!1,!0,!1,null,null,null,!0,null,null),new a.OpLUT("%dest = %cast(texture%texdim(%b,%texsize(%a)%lod).%dm);\n",null,!0,!0,!0,null,null,!0,null,!0,!0),new a.OpLUT("%dest = %cast(greaterThanEqual(%a,%b).%dm);\n",0,!0,!0,!0,null,null,!0,null,!0,null),new a.OpLUT("%dest = %cast(lessThan(%a,%b).%dm);\n",0,!0,!0,!0,null,null,!0,null,!0,null),new a.OpLUT("%dest = %cast(sign(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new a.OpLUT("%dest = %cast(equal(%a,%b).%dm);\n",0,!0,!0,!0,null,null,!0,null,!0,null),new a.OpLUT("%dest = %cast(notEqual(%a,%b).%dm);\n",0,!0,!0,!0,null,null,!0,null,!0,null)],b}();a.Mapping=b}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function a(){this.lodbias=0,this.dim=0,this.readmode=0,this.special=0,this.wrap=0,this.mipmap=0,this.filter=0}return a}();a.Sampler=b}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function b(){}return b.prototype.parse=function(b){var c="",d="";c+="precision highp float;\n";var e=b.header.type[0];if("vertex"==b.header.type&&(c+="uniform float yflip;\n"),b.hasindirect)c+="uniform vec4 "+e+"carrr[128];\n";else for(var f=0;f<b.regread[1].length;f++)b.regread[1][f]&&(c+="uniform vec4 "+e+"c"+f+";\n");for(var f=0;f<b.regread[2].length||f<b.regwrite[2].length;f++)(b.regread[2][f]||b.regwrite[2][f])&&(c+="vec4 "+e+"t"+f+";\n");for(var f=0;f<b.regread[0].length;f++)b.regread[0][f]&&(c+="attribute vec4 va"+f+";\n");for(var f=0;f<b.regread[4].length||f<b.regwrite[4].length;f++)(b.regread[4][f]||b.regwrite[4][f])&&(c+="varying vec4 vi"+f+";\n");for(var g=["2D","Cube","3D",""],f=0;f<b.samplers.length;f++)b.samplers[f]&&(c+="uniform sampler"+g[3&b.samplers[f].dim]+" fs"+f+";\n");"vertex"==b.header.type&&(c+="vec4 outpos;\n"),b.writedepth&&(c+="vec4 tmp_FragDepth;\n"),d+="void main() {\n";for(var f=0;f<b.tokens.length;f++){var h=a.Mapping.agal2glsllut[b.tokens[f].opcode];if(!h)throw"Opcode not valid or not implemented yet: ";for(var i=h.matrixheight||1,j=0;i>j;j++){var k="  "+h.s;if(b.tokens[f].dest){if(h.matrixheight){if(1!=(b.tokens[f].dest.mask>>j&1))continue;var l=this.regtostring(b.tokens[f].dest.regtype,b.tokens[f].dest.regnum,b,e),m="float",n=["x","y","z","w"][j];l+="."+n}else{var m,n,l=this.regtostring(b.tokens[f].dest.regtype,b.tokens[f].dest.regnum,b,e);if(15!=b.tokens[f].dest.mask){var o=0;switch(n="",1&b.tokens[f].dest.mask&&(o++,n+="x"),2&b.tokens[f].dest.mask&&(o++,n+="y"),4&b.tokens[f].dest.mask&&(o++,n+="z"),8&b.tokens[f].dest.mask&&(o++,n+="w"),l+="."+n,o){case 1:m="float";break;case 2:m="vec2";break;case 3:m="vec3";break;default:throw"Unexpected destination mask"}}else m="vec4",n="xyzw"}k=k.replace("%dest",l),k=k.replace("%cast",m),k=k.replace("%dm",n)}var p=15;if(!h.ndwm&&h.dest&&b.tokens[f].dest&&(p=b.tokens[f].dest.mask),b.tokens[f].a&&(k=k.replace("%a",this.sourcetostring(b.tokens[f].a,0,p,h.scalar,b,e))),b.tokens[f].b&&(k=k.replace("%b",this.sourcetostring(b.tokens[f].b,j,p,h.scalar,b,e)),5==b.tokens[f].b.regtype)){var q=["2D","Cube","3D"][b.tokens[f].b.dim],r=["vec2","vec3","vec3"][b.tokens[f].b.dim];
k=k.replace("%texdim",q),k=k.replace("%texsize",r);var s="";k=k.replace("%lod",s)}d+=k}}return"vertex"==b.header.type&&(d+="  gl_Position = vec4(outpos.x, outpos.y, outpos.z*2.0 - outpos.w, outpos.w);\n"),b.writedepth&&(d+="  gl_FragDepth = clamp(tmp_FragDepth,0.0,1.0);\n"),d+="}\n",c+d},b.prototype.regtostring=function(a,b,c,d){switch(a){case 0:return"va"+b;case 1:return c.hasindirect&&"vertex"==c.header.type?"vcarrr["+b+"]":d+"c"+b;case 2:return d+"t"+b;case 3:return"vertex"==c.header.type?"outpos":"gl_FragColor";case 4:return"vi"+b;case 5:return"fs"+b;case 6:return"tmp_FragDepth";default:throw"Unknown register type"}},b.prototype.sourcetostring=function(a,b,c,d,e,f){var g,h=["x","y","z","w"];if(a.indirectflag){g="vcarrr[int("+this.regtostring(a.indexregtype,a.regnum,e,f)+"."+h[a.indexselect]+")";var i=b+a.indexoffset;0>i&&(g+=i.toString()),i>0&&(g+="+"+i.toString()),g+="]"}else g=this.regtostring(a.regtype,a.regnum+b,e,f);return 5==a.regtype?g:d?g+"."+h[a.swizzle>>0&3]:228==a.swizzle&&15==c?g:(g+=".",1&c&&(g+=h[a.swizzle>>0&3]),2&c&&(g+=h[a.swizzle>>2&3]),4&c&&(g+=h[a.swizzle>>4&3]),8&c&&(g+=h[a.swizzle>>6&3]),g)},b}();a.AGLSLParser=b}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));var stageJS;!function(a){!function(a){var b=function(){function b(){}return b.prototype.decribeAGALByteArray=function(b){var c=new a.Header;if(160!=b.readUnsignedByte())throw"Bad AGAL: Missing 0xa0 magic byte.";if(c.version=b.readUnsignedInt(),c.version>=16&&(b.readUnsignedByte(),c.version>>=1),161!=b.readUnsignedByte())throw"Bad AGAL: Missing 0xa1 magic byte.";switch(c.progid=b.readUnsignedByte(),c.progid){case 1:c.type="fragment";break;case 0:c.type="vertex";break;case 2:c.type="cpu";break;default:c.type=""}for(var d=new a.Description,e=[];b.position<b.length;){var f=new a.Token;f.opcode=b.readUnsignedInt();var g=a.Mapping.agal2glsllut[f.opcode];if(!g)throw"Opcode not valid or not implemented yet: "+f.opcode;g.matrixheight&&(d.hasmatrix=!0),g.dest?(f.dest.regnum=b.readUnsignedShort(),f.dest.mask=b.readUnsignedByte(),f.dest.regtype=b.readUnsignedByte(),d.regwrite[f.dest.regtype][f.dest.regnum]|=f.dest.mask):(f.dest=null,b.readUnsignedInt()),g.a?this.readReg(f.a,1,d,b):(f.a=null,b.readUnsignedInt(),b.readUnsignedInt()),g.b?this.readReg(f.b,0|g.matrixheight,d,b):(f.b=null,b.readUnsignedInt(),b.readUnsignedInt()),e.push(f)}return d.header=c,d.tokens=e,d},b.prototype.readReg=function(a,b,c,d){if(a.regnum=d.readUnsignedShort(),a.indexoffset=d.readByte(),a.swizzle=d.readUnsignedByte(),a.regtype=d.readUnsignedByte(),c.regread[a.regtype][a.regnum]=15,5==a.regtype?(a.lodbiad=a.indexoffset,a.indexoffset=null,a.swizzle=null,a.readmode=d.readUnsignedByte(),a.dim=a.readmode>>4,a.readmode&=15,a.special=d.readUnsignedByte(),a.wrap=a.special>>4,a.special&=15,a.mipmap=d.readUnsignedByte(),a.filter=a.mipmap>>4,a.mipmap&=15,c.samplers[a.regnum]=a):(a.indexregtype=d.readUnsignedByte(),a.indexselect=d.readUnsignedByte(),a.indirectflag=d.readUnsignedByte()),a.indirectflag&&(c.hasindirect=!0),!a.indirectflag&&b)for(var e=0;b>e;e++)c.regread[a.regtype][a.regnum+e]=c.regread[a.regtype][a.regnum]},b}();a.AGALTokenizer=b}(a.utils||(a.utils={}));a.utils}(stageJS||(stageJS={}));